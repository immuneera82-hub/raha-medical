-- Enable UUID extension
create extension if not exists "uuid-ossp";

-- 1. Specialties Table (To link doctors and diseases)
create table if not exists specialties (
  id uuid default uuid_generate_v4() primary key,
  slug text unique not null,
  name_ar text not null,
  name_en text not null,
  description_ar text,
  description_en text,
  image_url text,
  created_at timestamp with time zone default timezone('utc'::text, now()) not null
);

-- 2. Hospitals Table
create table if not exists hospitals (
  id uuid default uuid_generate_v4() primary key,
  slug text unique not null,
  name_ar text not null,
  name_en text not null,
  overview_ar text,
  overview_en text,
  location text,
  city text,
  country text default 'India',
  image_url text,
  website_url text,
  is_partner boolean default true,
  jci_accredited boolean default false,
  success_rates jsonb, -- e.g., {"cardiology": "98%", "oncology": "95%"}
  created_at timestamp with time zone default timezone('utc'::text, now()) not null
);

-- 3. Doctors Table
create table if not exists doctors (
  id uuid default uuid_generate_v4() primary key,
  slug text unique not null,
  name_ar text not null,
  name_en text not null,
  specialty_id uuid references specialties(id),
  hospital_id uuid references hospitals(id),
  experience_years integer,
  cases_count integer, -- "Active Cases" or "Treated Cases"
  bio_ar text, -- Generated by AI
  bio_en text,
  qualifications text[], -- e.g. ["MBBS", "MD", "FRCS"]
  languages text[], -- e.g. ["Arabic", "English"]
  image_url text, -- Nano Banana Pro generated
  is_active boolean default true,
  created_at timestamp with time zone default timezone('utc'::text, now()) not null
);

-- 4. Medical Conditions (Diseases) - THE CORE KNOWLEDGE BASE
create table if not exists medical_conditions (
  id uuid default uuid_generate_v4() primary key,
  slug text unique not null, -- for URL: /knowledge-base/disease/breast-cancer
  code text unique, -- User requested "Patient Code" or ICD-10
  
  -- Basic Info
  name_ar text not null,
  name_en text not null,
  scientific_name text,
  
  -- Detailed Content (Matches User Template)
  definition_ar text,
  definition_en text,
  
  causes_ar text[], -- Array of strings for bullet points
  risk_factors_ar text[],
  
  symptoms_early_ar text[],
  symptoms_advanced_ar text[],
  
  when_to_see_doctor_ar text,
  
  diagnosis_methods_ar text[],
  required_tests_ar text[], -- "التحاليل المطلوبة"
  
  -- Outcomes & Treatment
  success_rates text, -- "نسب النجاح المتوقعة"
  treatment_options_ar text[],
  recovery_time_ar text,
  
  prevention_methods_ar text[],
  
  -- Marketing / Conversion
  why_choose_india_ar text,
  raha_services_ar text, -- "خدمات Raha Medical المتاحة"
  
  -- Relationships
  related_specialty_id uuid references specialties(id),
  
  -- FAQ & SEO
  faqs jsonb, -- [{"question": "...", "answer": "..."}]
  reliable_sources text[], -- URLs to WHO, Mayo Clinic
  
  -- Meta
  meta_title_ar text,
  meta_description_ar text,
  image_url text,
  
  created_at timestamp with time zone default timezone('utc'::text, now()) not null,
  updated_at timestamp with time zone default timezone('utc'::text, now()) not null
);

-- 5. Linking Table: Conditions <-> Hospitals (Many-to-Many)
-- Which hospitals treat which condition?
create table if not exists hospital_conditions (
  hospital_id uuid references hospitals(id) on delete cascade,
  condition_id uuid references medical_conditions(id) on delete cascade,
  primary key (hospital_id, condition_id)
);

-- RLS Policies (Row Level Security) - Public Read Access
alter table specialties enable row level security;
create policy "Allow public read access" on specialties for select using (true);

alter table hospitals enable row level security;
create policy "Allow public read access" on hospitals for select using (true);

alter table doctors enable row level security;
create policy "Allow public read access" on doctors for select using (true);

alter table medical_conditions enable row level security;
create policy "Allow public read access" on medical_conditions for select using (true);

alter table hospital_conditions enable row level security;
create policy "Allow public read access" on hospital_conditions for select using (true);
