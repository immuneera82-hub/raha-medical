#!/bin/bash

################################################################################
# ุณูุฑูุจุช ุชุญุฏูุซ ุณูุฑูุฑ Raha Medical
# ูููู ุจุณุญุจ ุงูุชุญุฏูุซุงุช ูู GitHub ูุฅุนุงุฏุฉ ุชุดุบูู ุงูุชุทุจูู
################################################################################

# ุฃููุงู ูููุฎุฑุฌุงุช
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# ุฏุงูุฉ ุทุจุงุนุฉ ุฑุณุงุฆู ููููุฉ
print_status() {
    echo -e "${BLUE}[INFO]${NC} $1"
}

print_success() {
    echo -e "${GREEN}[SUCCESS]${NC} $1"
}

print_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

print_warning() {
    echo -e "${YELLOW}[WARNING]${NC} $1"
}

################################################################################
# ุงูุฎุทูุฉ 1: ุงูุชุญูู ูู ูุฌูุฏ ุงููุฌูุฏ
################################################################################
print_status "ุงูุชุญูู ูู ูุฌูุฏ ูุฌูุฏ ุงููุดุฑูุน..."
if [ ! -d "/root/raha-medical" ]; then
    print_error "ูุฌูุฏ ุงููุดุฑูุน ุบูุฑ ููุฌูุฏ!"
    exit 1
fi

cd /root/raha-medical || exit 1
print_success "ุชู ุงูุงูุชูุงู ุฅูู ูุฌูุฏ ุงููุดุฑูุน"

################################################################################
# ุงูุฎุทูุฉ 2: ุนูู ูุณุฎุฉ ุงุญุชูุงุทูุฉ
################################################################################
print_status "ุฅูุดุงุก ูุณุฎุฉ ุงุญุชูุงุทูุฉ..."
BACKUP_DIR="/root/backups"
mkdir -p $BACKUP_DIR
BACKUP_FILE="$BACKUP_DIR/raha-backup-$(date +%Y%m%d-%H%M%S).tar.gz"

tar -czf "$BACKUP_FILE" \
    --exclude='node_modules' \
    --exclude='__pycache__' \
    --exclude='.git' \
    . 2>/dev/null

if [ $? -eq 0 ]; then
    print_success "ุชู ุฅูุดุงุก ุงููุณุฎุฉ ุงูุงุญุชูุงุทูุฉ: $BACKUP_FILE"
else
    print_warning "ูุดู ุฅูุดุงุก ุงููุณุฎุฉ ุงูุงุญุชูุงุทูุฉ (ุณูุชู ุงููุชุงุจุนุฉ)"
fi

################################################################################
# ุงูุฎุทูุฉ 3: ุณุญุจ ุงูุชุญุฏูุซุงุช ูู GitHub
################################################################################
print_status "ุณุญุจ ุงูุชุญุฏูุซุงุช ูู GitHub..."
git fetch origin
git pull origin main

if [ $? -ne 0 ]; then
    print_error "ูุดู ุณุญุจ ุงูุชุญุฏูุซุงุช ูู GitHub!"
    exit 1
fi

print_success "ุชู ุณุญุจ ุงูุชุญุฏูุซุงุช ุจูุฌุงุญ"

################################################################################
# ุงูุฎุทูุฉ 4: ุฅููุงู ุงูุญุงููุงุช
################################################################################
print_status "ุฅููุงู ุงูุญุงููุงุช..."
docker-compose down

if [ $? -ne 0 ]; then
    print_error "ูุดู ุฅููุงู ุงูุญุงููุงุช!"
    exit 1
fi

print_success "ุชู ุฅููุงู ุงูุญุงููุงุช"

################################################################################
# ุงูุฎุทูุฉ 5: ุฅุนุงุฏุฉ ุจูุงุก ูุชุดุบูู ุงูุญุงููุงุช
################################################################################
print_status "ุฅุนุงุฏุฉ ุจูุงุก ูุชุดุบูู ุงูุญุงููุงุช..."
docker-compose up -d --build

if [ $? -ne 0 ]; then
    print_error "ูุดู ุฅุนุงุฏุฉ ุจูุงุก ุงูุญุงููุงุช!"
    exit 1
fi

print_success "ุชู ุฅุนุงุฏุฉ ุจูุงุก ูุชุดุบูู ุงูุญุงููุงุช"

################################################################################
# ุงูุฎุทูุฉ 6: ุงูุงูุชุธุงุฑ ูุจุฏุก ุงูุฎุฏูุงุช
################################################################################
print_status "ุงูุงูุชุธุงุฑ ูุจุฏุก ุงูุฎุฏูุงุช..."
sleep 10

################################################################################
# ุงูุฎุทูุฉ 7: ุงูุชุญูู ูู ุญุงูุฉ ุงูุญุงููุงุช
################################################################################
print_status "ุงูุชุญูู ูู ุญุงูุฉ ุงูุญุงููุงุช..."
docker-compose ps

################################################################################
# ุงูุฎุทูุฉ 8: ุนุฑุถ ุณุฌูุงุช ุงูุชุทุจูู
################################################################################
print_status "ุนุฑุถ ุขุฎุฑ 30 ุณุทุฑ ูู ุณุฌูุงุช ุงูุชุทุจูู..."
docker-compose logs backend --tail=30

################################################################################
# ุงูุฎุทูุฉ 9: ุงุฎุชุจุงุฑ ุงูุตุญุฉ
################################################################################
print_status "ุงุฎุชุจุงุฑ ุงููุตูู ุฅูู ุงูุชุทุจูู..."
HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8000/health 2>/dev/null || echo "000")

if [ "$HTTP_CODE" = "200" ] || [ "$HTTP_CODE" = "404" ]; then
    print_success "ุงูุชุทุจูู ูุนูู ุจูุฌุงุญ!"
else
    print_warning "ุงูุชุทุจูู ูุฏ ูุง ูุนูู ุจุดูู ุตุญูุญ (HTTP Code: $HTTP_CODE)"
fi

################################################################################
# ููุฎุต ุงูุชุญุฏูุซ
################################################################################
echo ""
echo "================================================================================"
echo -e "${GREEN}ุชู ุฅููุงู ุงูุชุญุฏูุซ ุจูุฌุงุญ!${NC}"
echo "================================================================================"
echo "๐ ุงูุชุงุฑูุฎ: $(date '+%Y-%m-%d %H:%M:%S')"
echo "๐ฆ ุงููุณุฎุฉ ุงูุงุญุชูุงุทูุฉ: $BACKUP_FILE"
echo "๐ ุงููููุน: https://rahamedical.com"
echo "๐ ุตูุญุฉ ุงูุฃุณุฆูุฉ: https://rahamedical.com/faq"
echo "================================================================================"
echo ""
print_status "ููุฑุฌู ุงุฎุชุจุงุฑ ุงููููุน ููุชุฃูุฏ ูู ุฃู ูู ุดูุก ูุนูู ุจุดูู ุตุญูุญ."
echo ""
